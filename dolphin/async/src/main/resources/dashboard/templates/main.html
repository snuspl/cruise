<!DOCTYPE html>
<!-- Copyright (C) 2016 Seoul National University
     Licensed under the Apache License, Version 2.0 (the "License");
     you may not use this file except in compliance with the License.
     You may obtain a copy of the License at

             http://www.apache.org/licenses/LICENSE-2.0

     Unless required by applicable law or agreed to in writing, software
     distributed under the License is distributed on an "AS IS" BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     See the License for the specific language governing permissions and
     limitations under the License.
-->

<html>
<head>
    <title>Dolphin Dashboard</title>
    <link rel='stylesheet' href='http://www.w3schools.com/lib/w3.css'>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js'></script>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
</head>
<body>
    <div class='w3-container'>
        <h1>Dolphin</h1> 
    </div>
    <div class='w3-container'>
        <!-- Selection bar -->
        <ul class='w3-light-grey w3-navbar'>
            <li class='w3-col m2 l1' style='line-height:35px;text-align:center'>Detail</li>
            <!--objects-->
            <li><select onclick="getIdAndY();" class='w3-select w3-border w3-light-grey' id='objects'>
                    <option disabled selected hidden>Objects</option>
                    <option>Worker</option>
                    <option>Server</option>
                    <option>Custom</option>
            </select></li>
            <!--id-->
            <li><select class='w3-select w3-border w3-light-grey dd-query' id='id'>
                    <option disabled selected hidden>ID</option>
            </select></li>
            <!--x-axis-->
            <li><select class='w3-select w3-border w3-light-grey dd-query' id='x-axis'>
                    <option disabled selected hidden>X-axis</option>
                    <option>Time</option>
            </select></li>
            <!--y-axis-->
            <li><select class='w3-select w3-border w3-light-grey dd-query' id='y-axis'>
                    <option disabled selected hidden>Y-axis</option>
            </select></li>
            <li class='w3-black'><a href='javascript:reloadData()'>Reload data!</a></li>
        </ul>
        <!-- main display -->
        <div class='w3-container w3-border' id='main-display' style='height:80vh'>
        </div>
    </div>

    <script>
    var xAxis;
    var yAxis;
    var objects;
    var id;
    var requestTimer;

    // When users choose which object to see, change the y-axis-items to those belong to the objects.
    function getIdAndY() {
        clearInterval(requestTimer);
        var objects = $('#objects').val();
        $.post('/selectors', {position:objects}, function(json){
            var data = JSON.parse(json);
            if (data['id'].length > 0) {
                $('#id').html('<option disabled selected hidden>ID</option>');
                var position = (objects === 'Custom')? 'Worker' : objects;
                for (id in data['id']) {
                    $('#id').append('<option>' + position + '-' + data['id'][id] + '</option>');
                }
            }
            if (data['y'].length > 0) {
                $('#y-axis').html('<option disabled selected hidden>Y-axis</option>');
                for (y in data['y']) {
                    if (data['y'][y] != 'time' && data['y'][y] != 'id') {
                        $('#y-axis').append('<option>' + data['y'][y] + '</option>');
                    }
                }
            }
        });
    }

    // reload data from the server every 1 sec to provide real-time visualization.
    function reloadData() {
        clearInterval(requestTimer);
        requestTimer = window.setInterval(function(){
            var objects = $('#objects').val();
            var xAxis = $('#x-axis').val();
            var yAxis = $('#y-axis').val();
            var id = $('#id').val();
            $.post('/plot', {position:objects, x:xAxis, y:yAxis, id:id}, function(json) {
                var data = JSON.parse(json);
                var keys = Object.keys(data);
                if (keys.length == 0){
                    return;
                }
                keys.sort(function(a, b){return a-b;});
                var trace = {
                    x: keys,
                    y: keys.map(function(key){return data[key];}),
                    type: 'scatter'
                };
                var layout = {
                    title: '',
                    xaxis: {
                        title: 'Time (s)',
                        titlefont: {
                            size: 18,
                            color: '#7f7f7f'
                        }
                    },
                    yaxis: {
                        title: yAxis,
                        titlefont: {
                            size: 18,
                            color: '#7f7f7f'
                        }
                    }
                };
                Plotly.newPlot($('#main-display')[0], [trace], layout);
            }).fail(function() {
                console.log('Stop requesting.');
                clearInterval(requestTimer);
            });
        }, 1000);
    }

    $('.dd-query').change(function(){
        clearInterval(requestTimer);
    });
    </script>
</body>

</html>
